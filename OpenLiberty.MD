###### refarch-cloudnative-micro-customer

## Deploy Customer Application on Open Liberty

You can run your Spring Boot applications on Open Liberty. Open Liberty will be the packaged server and the application will run on it instead of the default embedded server. Below are steps to run the Customer application on Open Liberty.

## Table of Contents
+ [Deploy the CouchDB Docker Container](#deploy-the-couchdb-docker-container)
+ [Deploy the Customer locally](#deploy-the-customer-locally)
+ [Deploy the Customer Docker Container](#deploy-the-customer-docker-container)
+ [Validate the Customer Microservice API](#validate-the-customer-microservice-api)

## Deploy the CouchDB Docker Container

Run the CouchDB as a Docker container. Below is the command to start it.
```bash
# Start a CouchDB Container with a database user, a password, and create a new database
$ docker run --name customercouchdb -p 5984:5984 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=passw0rd -d couchdb
```

## Deploy the Customer locally

In this section you will build and run the Spring Boot application on Open Liberty locally using Maven. Before we show you how to do so, you will need to deploy a CouchDB Docker container as shown in [Deploy the CouchDB Docker Container](#deploy-the-couchdb-docker-container).

Once CouchDB is up and running, we can run the Spring Boot Customer application locally as follows:

1. Open [`src/main/resources/application.yml`](src/main/resources/application.yml) file, enter the following values for the fields below, and save the file:
    
```
# Server configuration
server:
  context-path: /micro
  port: 8080

# Spring properties
spring:
  application:
     name: customer-microservice

     cloudant:
        protocol: http
        username: admin
        password: passw0rd
        host: 127.0.0.1
        port: 5985
        database: customers

jwt:
  sharedSecret: ${HS256_KEY}
```

2. As the APIs in this microservice are OAuth protected, the HS256 shared secret used to sign the JWT generated by the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is needed to validate the access token provided by the caller.

To make things easier for you, we pasted below the 2048-bit secret that's included in the Customer Helm chart here, which you can export to your environment as follows:

```
$ export HS256_KEY="E6526VJkKYhyTFRFMC0pTECpHcZ7TGcq8pKsVVgz9KtESVpheEO284qKzfzg8HpWNBPeHOxNGlyudUHi6i8tFQJXC8PiI48RUpMh23vPDLGD35pCM0417gf58z5xlmRNii56fwRCmIhhV7hDsm3KO2jRv4EBVz7HrYbzFeqI45CaStkMYNipzSm2duuer7zRdMjEKIdqsby0JfpQpykHmC5L6hxkX0BT7XWqztTr6xHCwqst26O0g8r7bXSYjp4a"
```

However, if you must create your own 2048-bit secret, one can be generated using the following command:

```
$ cat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | fold -w 256 | head -n 1 | xargs echo -n
```

Note that if the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is deployed, it must use the same HS256 shared secret. 

3. Build the application as follows.
```bash
$ mvn package
```

4. Run the application on localhost.
```bash
$ java -jar target/liberty-customer-spring-0.1-SNAPSHOT.jar
```

Once it is deployed, you will see something like below.

```
Customer microservice is ready for business...
[AUDIT   ] CWWKZ0001I: Application thin-liberty-customer-spring-0.1-SNAPSHOT started in 10.603 seconds.
[AUDIT   ] CWWKF0012I: The server installed the following features: [servlet-4.0, springBoot-1.5].
[AUDIT   ] CWWKF0011I: The server BoostServer is ready to run a smarter planet.
```

That's it, you have successfully deployed the Customer microservice. To validate the service, have a look at [Validate the Customer Microservice API](#validate-the-customer-microservice-api)

## Deploy the Customer Docker Container

In this section you will run the Spring Boot application on Open Liberty using Docker. Before we show you how to do so, you will need to deploy the CouchDB Docker Container as shown in [Deploy the CouchDB Docker Container](#deploy-the-couchdb-docker-container).

Once it is deployed, we can run the Spring Boot Customer application on Open Liberty docker as follows:

1. Open [`src/main/resources/application.yml`](src/main/resources/application.yml) file, enter the following values as follows, and save the file:

```
# Server configuration
server:
  context-path: /micro
  port: 8080

# Spring properties
spring:
  application:
     name: customer-microservice

     cloudant:
        protocol: http
        username: admin
        password: passw0rd
        host: customercouchdb
        port: 5984
        database: customers

jwt:
  sharedSecret: ${HS256_KEY}
```

2. Modify your POM file to generate the Docker image. Follow the below steps.
- Open [`pom.xml`](pom.xml)
- Modify the `boost-maven-plugin` as below.

```
            <plugin>
                <groupId>io.openliberty.boost</groupId>
                <artifactId>boost-maven-plugin</artifactId>
                <version>0.1</version>
                <executions>
                  <execution>
                    <!-- <phase>package</phase>
                    <goals>
                        <goal>package</goal>
                    </goals> -->
                    <goals>
                      <goal>docker-build</goal>
                    </goals>
                  </execution>
                </executions>
            </plugin>
```

3. As the APIs in this microservice are OAuth protected, the HS256 shared secret used to sign the JWT generated by the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is needed to validate the access token provided by the caller.

To make things easier for you, we pasted below the 2048-bit secret that's included in the Customer Helm chart here, which you can export to your environment as follows:

```
$ export HS256_KEY="E6526VJkKYhyTFRFMC0pTECpHcZ7TGcq8pKsVVgz9KtESVpheEO284qKzfzg8HpWNBPeHOxNGlyudUHi6i8tFQJXC8PiI48RUpMh23vPDLGD35pCM0417gf58z5xlmRNii56fwRCmIhhV7hDsm3KO2jRv4EBVz7HrYbzFeqI45CaStkMYNipzSm2duuer7zRdMjEKIdqsby0JfpQpykHmC5L6hxkX0BT7XWqztTr6xHCwqst26O0g8r7bXSYjp4a"
```

However, if you must create your own 2048-bit secret, one can be generated using the following command:

```
$ cat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | fold -w 256 | head -n 1 | xargs echo -n
```

Note that if the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is deployed, it must use the same HS256 shared secret. 

4. To deploy the Customer container, run the following commands:

Before building the Docker image, make sure there are no other dockerfiles in your repo. If a dockerfile already exists, please remove it.

```bash
# Build the Docker Image
$ mvn clean install 
```

Once done, a Docker image named `liberty-customer-spring:latest` will be built automatically for you.

Run the Docker container as follows.

```
# Start the Customer Container    
$ docker run --name customer \
    -e COUCHDB_PROTOCOL=http \
    -e COUCHDB_USER=admin \
    -e COUCHDB_PASSWORD=password \
    -e COUCHDB_HOST=customercouchdb \
    -e COUCHDB_PORT=5985 \
    -e HS256_KEY=${HS256_KEY} \
    -p 9080:9080 \
    --link customercouchdb:customercouchdb \
    -d liberty-customer-spring:latest
```

That's it, you have successfully deployed the Customer microservice on Docker. To validate the service, have a look at [Validate the Customer Microservice API](#validate-the-customer-microservice-api)

## Validate the Customer Microservice API

Now that we have the customer service up and running, let's go ahead and test that the API works properly.

### Setup
#### a. Setup Customer Service Hostname and Port
To make going through this document easier, we recommend you create environment variables for the customer service hostname/IP and port. To do so, run the following commands:
```bash
$ export CUSTOMER_HOST=localhost
# For maven build, the port is 8080
$ export CUSTOMER_PORT=8080
# For docker build, the port is 9080
$ export CUSTOMER_PORT=9080
```

Where:
* `CUSTOMER_HOST` is the hostname or IP address for the customer service.
* `CUSTOMER_PORT` is the port for the customer service.

#### b. Create a temporary HS256 shared secret
As the APIs in this microservice as OAuth protected, the HS256 shared secret used to sign the JWT generated by the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is needed to validate the access token provided by the caller.

To make things easier for you, we pasted below the 2048-bit secret that's included in the Customer Helm chart [here](chart/customer/values.yaml#L28), which you can export to your environment as follows:
```bash
$ export HS256_KEY="E6526VJkKYhyTFRFMC0pTECpHcZ7TGcq8pKsVVgz9KtESVpheEO284qKzfzg8HpWNBPeHOxNGlyudUHi6i8tFQJXC8PiI48RUpMh23vPDLGD35pCM0417gf58z5xlmRNii56fwRCmIhhV7hDsm3KO2jRv4EBVz7HrYbzFeqI45CaStkMYNipzSm2duuer7zRdMjEKIdqsby0JfpQpykHmC5L6hxkX0BT7XWqztTr6xHCwqst26O0g8r7bXSYjp4a"
```

However, if you must create your own 2048-bit secret, one can be generated using the following command:
```bash
$ cat /dev/urandom | env LC_CTYPE=C tr -dc 'a-zA-Z0-9' | fold -w 256 | head -n 1 | xargs echo -n
```

Note that if the [Authorization Server](https://github.com/ibm-cloud-architecture/refarch-cloudnative-auth) is also deployed, it must use the *same* HS256 shared secret.

#### c. Generate a JWT Token with `admin` Scope
To generate a JWT Token with an `admin` scope, which will let you create/get/delete users, run the commands below:
```bash
# Exporting the admin user
export TEST_USER=foo
# JWT Header
jwt1=$(echo -n '{"alg":"HS256","typ":"JWT"}' | openssl enc -base64);
# JWT Payload
jwt2=$(echo -n "{\"scope\":[\"admin\"],\"user_name\":\"${TEST_USER}\"}" | openssl enc -base64);
# JWT Signature: Header and Payload
jwt3=$(echo -n "${jwt1}.${jwt2}" | tr '+\/' '-_' | tr -d '=' | tr -d '\r\n');
# JWT Signature: Create signed hash with secret key
jwt4=$(echo -n "${jwt3}" | openssl dgst -binary -sha256 -hmac "${HS256_KEY}" | openssl enc -base64 | tr '+\/' '-_' | tr -d '=' | tr -d '\r\n');
# Complete JWT
jwt=$(echo -n "${jwt3}.${jwt4}");
```

Where:
* `admin` is the scope needed to create the user.
* `${TEST_USER}` is the user to create, i.e. `foo`.
* `${HS256_KEY}` is the 2048-bit secret from the previous step.

### 1. Create a Customer
Let's create a new customer with username `foo` and password `bar` and its respective profile with the following command:
```bash
$ curl -X POST -i "http://${CUSTOMER_HOST}:${CUSTOMER_PORT}/micro/customer" -H "Content-Type: application/json" -H "Authorization: Bearer ${jwt}" -d "{\"username\": \"${TEST_USER}\", \"password\": \"bar\", \"firstName\": \"foo\", \"lastName\": \"bar\", \"email\": \"foo@bar.com\"}"
```

When it is successful, you will see something similar to below.
```
HTTP/1.1 201 Created
X-Powered-By: Servlet/4.0
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
X-Application-Context: customer-microservice:8080
Location: http://localhost:8080/micro/customer/4533316ae77649d4bd6a44a86626d599
Content-Language: en-US
Transfer-Encoding: chunked
Date: Mon, 15 Oct 2018 19:01:13 GMT
```

Where:
* `${CUSTOMER_HOST}` is the hostname/IP address for the customer microservice.
* `${CUSTOMER_PORT}` is the port for the customer microservice.
* `${jwt}` is the JWT token created in the previous step.
* `${TEST_USER}` is the user to create, i.e. `foo`.

Note that the returned `Location` header contains the `CUSTOMER_ID` of the created customer.  For the GET calls below, copy the ID in the `Location` header (e.g. in the above, `4533316ae77649d4bd6a44a86626d599`). This id will be used later when deleting the user. To save it in your environment, run the following command using the the id returned above:
```bash
# In this case, we are using the id that was returned in our sample command above, which will differ for you
$ CUSTOMER_ID=4533316ae77649d4bd6a44a86626d599
```

### 2. Search the Customer
To search users with a particular username, i.e. `foo`, run the command below:
```bash
$ curl -s -X GET "http://${CUSTOMER_HOST}:${CUSTOMER_PORT}/micro/customer/search?username=${TEST_USER}" -H 'Content-type: application/json' -H "Authorization: Bearer ${jwt}"
```

When it is successful, you will see something similar to below.
```
[{"username":"foo","password":"bar","firstName":"foo","lastName":"bar","email":"foo@bar.com","imageUrl":null,"customerId":"4533316ae77649d4bd6a44a86626d599"}]
```

Where:
* `${CUSTOMER_HOST}` is the hostname/IP address for the customer microservice.
* `${CUSTOMER_PORT}` is the port for the customer microservice.
* `${jwt}` is the JWT token created in the previous step.
* `${TEST_USER}` is the user to create, i.e. `foo`.

### 3. Get the Customer
To use the customer service as a non-admin user and still be able to retrieve a user's own record, you must create a JWT token with the `blue` scope and pass the customer id as the value for the `user_name` payload. By doing this, we guarantee that only the identied user can retrieve/update/delete it's own record.

Run the below command to set the CUSTOMER_ID. This is the id of the customer user created earlier.
```
$ export CUSTOMER_ID=4533316ae77649d4bd6a44a86626d599
```

#### Generate a JWT Token with `blue` Scope for New Customer

In order for the newly created user to retrieve its own record, and only its own record, you will need to create a new JWT token with the scope `blue` and a payload that has the `CUSTOMER_ID` as the value for `user_name`. To generate the new JWT token, run the following commands:
```bash
# JWT Header
jwt1=$(echo -n '{"alg":"HS256","typ":"JWT"}' | openssl enc -base64);
# JWT Payload
jwt2=$(echo -n "{\"scope\":[\"blue\"],\"user_name\":\"${CUSTOMER_ID}\"}" | openssl enc -base64);
# JWT Signature: Header and Payload
jwt3=$(echo -n "${jwt1}.${jwt2}" | tr '+\/' '-_' | tr -d '=' | tr -d '\r\n');
# JWT Signature: Create signed hash with secret key
jwt4=$(echo -n "${jwt3}" | openssl dgst -binary -sha256 -hmac "${HS256_KEY}" | openssl enc -base64 | tr '+\/' '-_' | tr -d '=' | tr -d '\r\n');
# Complete JWT
jwt_blue=$(echo -n "${jwt3}.${jwt4}");
```

Where:
* `blue` is the scope needed to create the user.
* `${CUSTOMER_ID}` is the id of the customer user crated earlier, i.e. `4533316ae77649d4bd6a44a86626d599`.
* `${HS256_KEY}` is the 2048-bit secret from the previous step.

#### Use `blue` Scoped JWT Token to Retrieve the Customer Record
To retrieve the customer record using the `blue` scoped JWT token, run the command below:
```bash
$ curl -s -X GET "http://${CUSTOMER_HOST}:${CUSTOMER_PORT}/micro/customer" -H "Authorization: Bearer ${jwt_blue}"
```
When it is successful, you will see something similar to below.
```
[{"username":"foo","password":"bar","firstName":"foo","lastName":"bar","email":"foo@bar.com","imageUrl":null,"customerId":"4533316ae77649d4bd6a44a86626d599"}]
```

Note that *only* the customer object identified by the encoded `user_name` is returned to the caller.

### 4. Delete the Customer
Using either the `admin` or the `blue` scoped JWT token, you can delete the customer record. If using the `blue` scoped JWT token, *only* the customer object identified by the encoded `user_name` can be deleted. To run with the `blue` scoped JWT token to delete the user, run the command below:
```bash
$ curl -X DELETE -i "http://${CUSTOMER_HOST}:${CUSTOMER_PORT}/micro/customer/${CUSTOMER_ID}" -H "Content-type: application/json" -H "Authorization: Bearer ${jwt_blue}"
```
When it is successful, you will see something similar to below.
```
HTTP/1.1 200 OK
X-Powered-By: Servlet/4.0
X-Application-Context: customer-microservice:8080
Content-Language: en-US
Transfer-Encoding: chunked
Date: Mon, 15 Oct 2018 19:10:09 GMT
```

Where:
* `${CUSTOMER_HOST}` is the hostname/ip address for the customer microservice.
* `${CUSTOMER_PORT}` is the port for the customer microservice.
* `${CUSTOMER_ID}` is the id of the customer user crated earlier, i.e. `4533316ae77649d4bd6a44a86626d599`.
* `${jwt_blue}` is the JWT token created in the previous step.

If successful, you should get a `200 OK` status code as shown in the command above.
